from exploits.exploit import MacExploit
from src.kernels import KernelWindow
from constants import *


class CVE20155889(MacExploit):
	def __init__(self):
		MacExploit.__init__(self)
		self.name = "CVE20155889"
		self.formatted_name = "CVE-2015-5889"
		self.e_type = "mac"
		self.brief_desc = "issetugid() + rsh + libmalloc osx local root"
		self.reliability = MEDIUM_RELIABILITY
		self.vulnerable_base = KernelWindow(GENERIC_MAC, BASE_VULNERABLE, 10, 9, 5, 10, 10, 5)
		self.vulnerable_kernels = [
			KernelWindow(GENERIC_MAC, VERSION_VULNERABLE, 10, 9, 5, 10, 10, 5)
		]
		self.exploit_kernels = [
			KernelWindow(GENERIC_MAC, EXPLOIT_AVAILABLE, 10, 9, 5, 10, 10, 5)
		]
		self.architecture = ARCHITECTURE_GENERIC
		self.source_c_path = os.path.join(MAC_EXPLOIT_PATH, "{}.c".format(self.name))
		self.compilation_path = os.path.join(PLAYGROUND_PATH, self.name)
		self.exploit_command = "python {}.py".format(self.compilation_path)

	def determine_vulnerability(self):
		color_print("\t[*] checking exploitation prerequisites for {}".format(self.name), color="blue")
		# if kernel matches...it should be vulnerable
		color_print("\t[-] system appears not to be vulnerable to {}".format(self.name), color="red")
		return True

	def exploit(self):
		"""
		We need to override base exploit because we're running a python script, not compiling C source
		"""
		perform_exploitation = str(
			input("Would you like to run exploit {} on this system? (y/n): ".format(self.name)))
		if "y" in perform_exploitation.lower():
			color_print("\t[*] performing exploitation of {}".format(self.name))
			color_print("\t[*] {}".format(self.exploit_command))
			try:
				subprocess.call(self.exploit_command)
			except:
				self.exploit_failure("exploitation interrupted")
		else:
			self.exploit_failure("canceled execution of exploit {}".format(self.name))
